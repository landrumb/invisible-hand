{% extends 'base.html' %}
{% block title %}Securities Desk{% endblock %}
{% block content %}
<section class="grid securities-grid">
  <article class="panel wide">
    <h2>Primary Securities</h2>
    <p class="muted">Prices evolve every {{ update_interval|int }} seconds based on stochastic supply and demand dynamics.</p>
    <table class="quotes" id="securities-quotes">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Name</th>
          <th>Last Price</th>
          <th>Δ</th>
          <th>Position</th>
          <th>Description</th>
          <th>Trade</th>
        </tr>
      </thead>
      <tbody>
        {% for security in securities %}
          {% set position = security_positions.get(security.symbol) %}
          <tr data-symbol="{{ security.symbol }}">
            <td class="mono">{{ security.symbol }}</td>
            <td>{{ security.name }}</td>
            <td class="mono price">{{ '%.2f'|format(security.last_price) }}</td>
            <td class="mono change">0.00</td>
            <td>
              {% if position and position.quantity %}
                {{ '%.2f'|format(position.quantity) }} @ {{ '%.2f'|format(position.average_price) }}
              {% else %}
                —
              {% endif %}
            </td>
            <td class="description">{{ security.description }}</td>
            <td>
              <form method="post" action="{{ url_for('main.trade_security') }}" class="trade-form">
                <input type="hidden" name="symbol" value="{{ security.symbol }}">
                <label class="sr-only" for="qty-{{ loop.index }}">Quantity</label>
                <input id="qty-{{ loop.index }}" name="quantity" type="number" min="0.1" step="0.1" value="1" required>
                <button type="submit" name="side" value="buy">Buy</button>
                <button type="submit" name="side" value="sell">Sell</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </article>

  <article class="panel">
    <h3>European Options</h3>
    <p class="muted">Premiums computed via Black–Scholes with a risk-free rate of {{ '%.2f'|format(risk_free_rate * 100) }}%.</p>
    <table class="quotes compact">
      <thead>
        <tr>
          <th>Contract</th>
          <th>Expiry</th>
          <th>Strike</th>
          <th>Premium</th>
          <th>Your Position</th>
          <th>Trade</th>
        </tr>
      </thead>
      <tbody>
        {% for quote in option_quotes %}
          {% set listing = quote.listing %}
          {% set holding = quote.holding %}
          <tr>
            <td class="mono">{{ listing.security_symbol }} {{ listing.option_type.value|upper }}</td>
            <td>{{ listing.expiration.strftime('%Y-%m-%d') }}</td>
            <td class="mono">{{ '%.2f'|format(listing.strike) }}</td>
            <td class="mono">{{ '%.2f'|format(quote.premium) }}</td>
            <td>
              {% if holding and holding.quantity %}
                {{ holding.quantity }} @ {{ '%.2f'|format(holding.average_premium) }}
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              <form method="post" action="{{ url_for('main.trade_option') }}" class="trade-form">
                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                <input name="quantity" type="number" min="1" step="1" value="1" required>
                <button type="submit" name="side" value="buy">Buy</button>
                <button type="submit" name="side" value="sell">Sell</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="6">No option listings available.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </article>

  <article class="panel">
    <h3>Forward Futures</h3>
    <p class="muted">Quoted on a cost-of-carry model; a 10% margin is posted or released with each adjustment.</p>
    <table class="quotes compact">
      <thead>
        <tr>
          <th>Contract</th>
          <th>Delivery</th>
          <th>Forward</th>
          <th>Your Position</th>
          <th>Adjust</th>
        </tr>
      </thead>
      <tbody>
        {% for quote in future_quotes %}
          {% set listing = quote.listing %}
          {% set holding = quote.holding %}
          <tr>
            <td class="mono">{{ listing.security_symbol }} FUT</td>
            <td>{{ listing.delivery_date.strftime('%Y-%m-%d') }}</td>
            <td class="mono">{{ '%.2f'|format(quote.forward) }}</td>
            <td>
              {% if holding and holding.quantity %}
                {{ holding.quantity }} @ {{ '%.2f'|format(holding.entry_price) }}
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              <form method="post" action="{{ url_for('main.trade_future') }}" class="trade-form">
                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                <input name="quantity" type="number" min="1" step="1" value="1" required>
                <button type="submit" name="side" value="long">Long</button>
                <button type="submit" name="side" value="short">Short</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="5">No futures available.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </article>
</section>

<script>
  const refreshInterval = Math.max(1000, {{ update_interval|int }} * 1000);
  async function refreshQuotes() {
    try {
      const response = await fetch("{{ url_for('main.securities_snapshot') }}", {cache: 'no-cache'});
      if (!response.ok) {
        return;
      }
      const data = await response.json();
      data.forEach(entry => {
        const row = document.querySelector(`#securities-quotes tbody tr[data-symbol="${entry.symbol}"]`);
        if (!row) {
          return;
        }
        const priceCell = row.querySelector('.price');
        const changeCell = row.querySelector('.change');
        if (priceCell) {
          priceCell.textContent = entry.price.toFixed(2);
        }
        if (changeCell) {
          const delta = entry.change || 0;
          changeCell.textContent = delta.toFixed(2);
          changeCell.classList.toggle('positive', delta > 0);
          changeCell.classList.toggle('negative', delta < 0);
        }
      });
    } catch (err) {
      console.error('Failed to refresh quotes', err);
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    refreshQuotes();
    setInterval(refreshQuotes, refreshInterval);
  });
</script>
{% endblock %}
