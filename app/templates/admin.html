{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<section class="grid">
  <article class="panel">
    <h2>Price Movement</h2>
    <table class="table">
      <thead>
        <tr><th>Product</th><th>Initial</th><th>Latest</th><th>Change</th><th>%</th></tr>
      </thead>
      <tbody>
        {% for row in stats %}
          <tr>
            <td>{{ row.product.name }}</td>
            <td>{{ '%.2f'|format(row.initial_price) }}</td>
            <td>{{ '%.2f'|format(row.latest_price) }}</td>
            <td class="amount {{ 'positive' if row.change >= 0 else 'negative' }}">{{ '%.2f'|format(row.change) }}</td>
            <td>{{ '%.1f'|format(row.percent_change) }}%</td>
          </tr>
        {% else %}
          <tr><td colspan="5">No price history yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </article>

  <article class="panel">
    <h2>Recent Transactions</h2>
    <ul class="list" id="txn-feed">
      {% for txn in transactions %}
        <li data-id="{{ txn.id }}">
          <span>{{ format_nyc_datetime(txn.created_at, '%H:%M:%S') }}</span>
          <span>{{ txn.user.name }} — {{ txn.description }}</span>
          <span class="amount {{ 'positive' if txn.amount >= 0 else 'negative' }}">{{ '%.2f'|format(txn.amount) }}</span>
        </li>
      {% else %}
        <li>No transactions yet.</li>
      {% endfor %}
    </ul>
  </article>

  <article class="panel">
    <h2>Casino Earnings</h2>
    {% set status = casino_status or {} %}
    <ul class="list">
      <li>Pending profit: {{ '%.2f'|format(status.get('pending_profit', 0.0) or 0.0) }} credits</li>
      <li>Last publication: {{ format_nyc_datetime(status.get('last_publish_at'), '%Y-%m-%d %H:%M:%S') if status.get('last_publish_at') else 'Never' }}</li>
      <li>Next scheduled: {{ format_nyc_datetime(status.get('next_publish_at'), '%Y-%m-%d %H:%M:%S') if status.get('next_publish_at') else 'Pending' }}</li>
      <li>Last summary: {{ status.get('last_summary') or 'No publication yet.' }}</li>
    </ul>
    <form method="post" action="{{ url_for('main.admin_casino_publish') }}" class="form">
      <button class="button" type="submit">Publish Earnings Now</button>
    </form>
    <p class="note">Immediately run the casino dividend/buyback cycle regardless of schedule.</p>
  </article>

  <article class="panel">
    <h2>Pricing & Reward Sensitivities</h2>
    <form method="post" action="{{ url_for('main.update_pricing_settings') }}" class="form">
      <label>Increase on purchase (%)
        <input type="number" name="price_increase_pct" step="0.1" min="0" value="{{ price_increase_pct or '5.0' }}">
      </label>
      <div class="grid">
        <div>
          <h3>Single Player</h3>
          <label>Decrease rewards after payout (%)
            <input type="number" name="sp_dec" step="0.1" min="0" value="{{ sp_dec or '5.0' }}">
          </label>
          <p class="note">Current multiplier: {{ sp_mult or '1.0' }}</p>
        </div>
        <div>
          <h3>Prisoner's Dilemma</h3>
          <label>Decrease rewards after payout (%)
            <input type="number" name="pd_dec" step="0.1" min="0" value="{{ pd_dec or '5.0' }}">
          </label>
          <p class="note">Current multiplier: {{ pd_mult or '1.0' }}</p>
        </div>
      </div>
      <button class="button" type="submit">Save</button>
    </form>
    <p class="note">Purchase increases item price; game wins reduce future rewards via per-game multipliers.</p>
  </article>

  <article class="panel">
    <h2>Assign Roles</h2>
    <form method="post" action="{{ url_for('main.assign_role') }}" class="form">
      <label>User
        <select name="user_id" required>
          {% for user in users %}
            <option value="{{ user.id }}">{{ user.name }} ({{ user.role.value }})</option>
          {% endfor %}
        </select>
      </label>
      <label>Role
        <select name="role" required>
          {% for role in ['player', 'merchant', 'admin'] %}
            <option value="{{ role }}">{{ role|capitalize }}</option>
          {% endfor %}
        </select>
      </label>
      <button class="button" type="submit">Assign</button>
    </form>
    <p class="note">Use the Flask shell to create the first admin or adjust roles directly.</p>
  </article>

  <article class="panel">
    <h2>Send Player Alert</h2>
    <form method="post" action="{{ url_for('main.create_alert') }}" class="form">
      <label>Message
        <textarea name="message" required placeholder="What's happening?" rows="3"></textarea>
      </label>
      <fieldset class="fieldset">
        <legend>Audience</legend>
        <label class="radio">
          <input type="radio" name="audience" value="all" checked>
          All players
        </label>
        <label class="radio">
          <input type="radio" name="audience" value="handle">
          Specific handle
        </label>
        <input type="text" name="target_handle" placeholder="player-handle" />
      </fieldset>
      <button class="button" type="submit">Send alert</button>
    </form>
    <p class="note">Alerts show up in the new player inbox. Handles use the part of their email before the @ symbol.</p>
  </article>

  <article class="panel">
    <h2>Shareholder Votes</h2>
    <form method="post" action="{{ url_for('main.create_shareholder_vote') }}" class="form">
      <label>Security
        <select name="security_symbol" required>
          {% for security in securities %}
            <option value="{{ security.symbol }}" {% if vote_defaults and vote_defaults.security_symbol == security.symbol %}selected{% endif %}>{{ security.symbol }} — {{ security.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Title
        <input type="text" name="vote_title" required placeholder="Annual meeting proposal" value="{{ vote_defaults.vote_title if vote_defaults else '' }}">
      </label>
      <label>Message
        <textarea name="vote_message" rows="3" required placeholder="Describe the proposal and any relevant context.">{{ vote_defaults.vote_message if vote_defaults else '' }}</textarea>
      </label>
      <label>Options (one per line)
        <textarea name="vote_options" rows="3" required placeholder="Approve&#10;Reject">{{ vote_defaults.vote_options if vote_defaults else '' }}</textarea>
      </label>
      <label>Voting deadline
        <input type="datetime-local" name="vote_deadline" required value="{{ vote_defaults.vote_deadline if vote_defaults else '' }}">
      </label>
      <button class="button" type="submit">Start vote</button>
    </form>
    <p class="note">Players holding the selected security receive an alert with a link to the vote. Voting weight is based on shares held at the deadline.</p>

    <div class="vote-admin-columns">
      <div>
        <h3>Open votes</h3>
        <ul class="list vote-list">
          {% for vote in open_votes %}
            <li>
              <strong>{{ vote.title }}</strong>
              <span class="muted">{{ vote.security_symbol }} · closes {{ format_nyc_datetime(vote.deadline) }}</span>
              <a class="button secondary" href="{{ url_for('main.view_shareholder_vote', vote_id=vote.id) }}">View vote</a>
            </li>
          {% else %}
            <li>No open votes.</li>
          {% endfor %}
        </ul>
      </div>
      <div>
        <h3>Recent votes</h3>
        <ul class="list vote-list">
          {% for vote in recent_votes %}
            <li>
              <strong>{{ vote.title }}</strong>
              {% if vote.finalized_at %}
                <span class="muted">Closed {{ format_nyc_datetime(vote.finalized_at) }}</span>
              {% else %}
                <span class="muted">Open · closes {{ format_nyc_datetime(vote.deadline) }}</span>
              {% endif %}
              <a class="button secondary" href="{{ url_for('main.view_shareholder_vote', vote_id=vote.id) }}">Details</a>
            </li>
          {% else %}
            <li>No votes yet.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </article>

  <article class="panel">
    <h2>Recent Alerts</h2>
    <ul class="list">
      {% for alert in alerts %}
        <li>
          <span>{{ format_nyc_datetime(alert.created_at, '%H:%M:%S') }}</span>
          <span>{{ alert.creator.name if alert.creator else 'Admin' }} — {{ alert.title or alert.message }}</span>
        </li>
      {% else %}
        <li>No alerts sent yet.</li>
      {% endfor %}
    </ul>
  </article>

  <article class="panel">
    <h2>Per-Product Sensitivities</h2>
    <form method="post" action="{{ url_for('main.merchant_portal') }}" class="form">
      <input type="hidden" name="action" value="update_product_increase_pct">
      <label>Product
        <select name="product_id" required>
          {% for product in products %}
            <option value="{{ product.id }}">{{ product.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Per-product price increase (%)
        <input type="number" step="0.1" name="increase_pct" min="0">
      </label>
      <button class="button" type="submit">Save</button>
    </form>
    <p class="note">Overrides global purchase increase for the selected product.</p>
  </article>
</section>

<script>
async function refreshTransactions() {
  const response = await fetch('{{ url_for('main.admin_transactions_feed') }}');
  if (!response.ok) return;
  const data = await response.json();
  const list = document.getElementById('txn-feed');
  list.innerHTML = '';
  data.forEach(item => {
    const li = document.createElement('li');
    li.dataset.id = item.id;
    li.innerHTML = `
      <span>${new Date(item.timestamp).toLocaleTimeString()}</span>
      <span>${item.user} — ${item.description}</span>
      <span class="amount ${item.amount >= 0 ? 'positive' : 'negative'}">${item.amount.toFixed(2)}</span>
    `;
    list.appendChild(li);
  });
}
setInterval(refreshTransactions, 5000);
</script>
{% endblock %}
