{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<section class="grid">
  <article class="panel">
    <h2>{{ current_user.name }}</h2>
    <p class="stat">Balance: <strong>{{ '%.2f'|format(balance) }}</strong></p>
    <p class="stat">Role: <strong>{{ current_user.role.value|capitalize }}</strong></p>
    <p class="stat">User ID: <strong>{{ current_user.id }}</strong></p>
    <p class="stat">Handle: <strong>{{ current_user.email.split('@')[0] }}</strong></p>
    {% if qr_data_uri %}
      <div class="qr-wrapper">
        <img src="{{ qr_data_uri }}" alt="QR code to send or request credits from {{ current_user.name }}" />
        <p>Share this code so others can target <strong>{{ current_user.email.split('@')[0] }}</strong> when sending or requesting credits.</p>
      </div>
    {% endif %}
  </article>
  <article class="panel">
    <h3>Send Credits</h3>
    <form class="form" method="post" action="{{ url_for('main.handle_transfer') }}">
      <input type="hidden" name="action" value="send" />
      <label>
        Recipient handle
        <input type="text" name="handle" value="{{ target_handle }}" placeholder="friend" required />
      </label>
      <label>
        Amount
        <input type="number" name="amount" min="0.01" step="0.01" placeholder="10.00" required />
      </label>
      <label>
        Message <span class="muted">(optional)</span>
        <textarea name="message" placeholder="What is this transfer for?"></textarea>
      </label>
      <div class="actions">
        <button type="submit" class="button primary">Send credits</button>
      </div>
    </form>
  </article>
  <article class="panel">
    <h3>Request Credits</h3>
    <form class="form" method="post" action="{{ url_for('main.handle_transfer') }}">
      <input type="hidden" name="action" value="request" />
      <label>
        From handle
        <input type="text" name="handle" value="{{ target_handle }}" placeholder="merchant" required />
      </label>
      <label>
        Amount
        <input type="number" name="amount" min="0.01" step="0.01" placeholder="25.00" required />
      </label>
      <label>
        Message <span class="muted">(optional)</span>
        <textarea name="message" placeholder="Add a note to your request."></textarea>
      </label>
      <div class="actions">
        <button type="submit" class="button">Request credits</button>
      </div>
    </form>
  </article>
  <article class="panel">
    <h3>Recent Transactions</h3>
    <ul class="list">
      {% for txn in transactions %}
        <li>
          <span>{{ txn.created_at.strftime('%H:%M:%S') }}</span>
          <span>{{ txn.description }}</span>
          <span class="amount {{ 'positive' if txn.amount >= 0 else 'negative' }}">{{ '%.2f'|format(txn.amount) }}</span>
        </li>
      {% else %}
        <li>No transactions yet.</li>
      {% endfor %}
    </ul>
  </article>
  <article class="panel">
    <h3>Incoming Requests</h3>
    {% if incoming_requests %}
      <div class="request-list">
        {% for req in incoming_requests %}
          <div class="request-item">
            <header>
              <strong>{{ req.requester.name }}</strong>
              <span>{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </header>
            <p class="muted">requested <strong>{{ '%.2f'|format(req.amount) }}</strong> credits</p>
            {% if req.message %}
              <p class="muted">“{{ req.message }}”</p>
            {% endif %}
            <div class="request-item-actions">
              <form method="post" action="{{ url_for('main.respond_money_request', request_id=req.id) }}">
                <input type="hidden" name="action" value="accept" />
                <button type="submit" class="button primary">Send now</button>
              </form>
              <form method="post" action="{{ url_for('main.respond_money_request', request_id=req.id) }}">
                <input type="hidden" name="action" value="decline" />
                <button type="submit" class="button danger">Decline</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No pending requests.</p>
    {% endif %}
  </article>
  <article class="panel">
    <h3>Your Requests</h3>
    {% if outgoing_requests %}
      <div class="request-list">
        {% for req in outgoing_requests %}
          <div class="request-item">
            <header>
              <strong>{{ req.target.name }}</strong>
              <span>{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </header>
            <p class="muted">asked for <strong>{{ '%.2f'|format(req.amount) }}</strong> credits</p>
            {% if req.message %}
              <p class="muted">“{{ req.message }}”</p>
            {% endif %}
            <p class="muted">Status: {{ req.status|capitalize }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">You haven't made any requests yet.</p>
    {% endif %}
  </article>
  {% if active_match %}
    <article class="panel">
      <h3>Active Match</h3>
      <p>You are matched with {{ active_match.player1.name if active_match.player2_id == current_user.id else active_match.player2.name }}.</p>
      <p>Status: {{ active_match.status|replace('_', ' ')|title }}</p>
      {% if active_match.status != 'completed' %}
        <a class="button" href="{{ url_for('main.prisoners_dilemma') }}">Go to match</a>
      {% endif %}
    </article>
  {% endif %}
</section>
{% endblock %}
